<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…ë°© í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>ğŸ—¨ï¸ ì±„íŒ…ë°© ëª©ë¡</h2>

<div>
    <input type="text" id="roomName" placeholder="ì±„íŒ…ë°© ì´ë¦„ ì…ë ¥" />
    <button onclick="createRoom()">ë°© ë§Œë“¤ê¸°</button>
</div>

<ul id="room-list"></ul>

<hr/>

<div id="chat-area" style="display:none;">
    <h3 id="chat-room-title"></h3>
    <input type="text" id="sender" placeholder="ë‹‰ë„¤ì„" />
    <input type="text" id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
    <button onclick="sendMessage()">ì „ì†¡</button>

    <ul id="chat-box"></ul>
</div>

<script>
    let stompClient = null;
    let currentRoomId = null;

    // ë°© ìƒì„± ìš”ì²­
    function createRoom() {
        const roomName = document.getElementById("roomName").value;
        if (!roomName) return;

        fetch("/api/rooms?name=" + encodeURIComponent(roomName), {
            method: "POST"
        }).then(() => {
            document.getElementById("roomName").value = '';
            loadRoomList();
        });
    }

    // ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadRoomList() {
        fetch("/api/rooms")
            .then(res => res.json())
            .then(data => {
                const roomList = document.getElementById("room-list");
                roomList.innerHTML = '';
                data.forEach(room => {
                    const li = document.createElement("li");
                    li.innerHTML = `<button onclick="enterRoom('${room.roomId}', '${room.name}')">${room.name}</button>`;
                    roomList.appendChild(li);
                });
            });
    }

    // ë°© ì…ì¥
    function enterRoom(roomId, roomName) {
        currentRoomId = roomId;
        document.getElementById("chat-area").style.display = "block";
        document.getElementById("chat-room-title").innerText = "ì±„íŒ…ë°©: " + roomName;
        document.getElementById("chat-box").innerHTML = "";

        connectWebSocket(roomId);
    }

    // WebSocket ì—°ê²° ë° êµ¬ë…
    function connectWebSocket(roomId) {
        const socket = new SockJS("/ws-chat");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
            stompClient.subscribe("/topic/room/" + roomId, function (msg) {
                const chat = JSON.parse(msg.body);
                const li = document.createElement("li");
                li.innerText = `${chat.sender}: ${chat.content}`;
                document.getElementById("chat-box").appendChild(li);
            });
        });
    }

    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
        const sender = document.getElementById("sender").value;
        const message = document.getElementById("message").value;

        if (!stompClient || !stompClient.connected || !currentRoomId) return;

        stompClient.send("/app/chat.send", {}, JSON.stringify({
            sender: sender,
            content: message,
            roomId: currentRoomId
        }));

        document.getElementById("message").value = '';
    }

    // ì²˜ìŒ í˜ì´ì§€ ë¡œë“œ ì‹œ ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    loadRoomList();
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…ë°© í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>ğŸ—¨ï¸ ì±„íŒ…ë°© ëª©ë¡</h2>

<!-- ì±„íŒ…ë°© ìƒì„± -->
<div>
    <input type="text" id="roomName" placeholder="ì±„íŒ…ë°© ì´ë¦„ ì…ë ¥" />
    <button onclick="createRoom()">ë°© ë§Œë“¤ê¸°</button>
</div>

<!-- ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ í‘œì‹œ ì˜ì—­ -->
<ul id="room-list"></ul>

<hr/>

<!-- ì±„íŒ… ì˜ì—­ - ì±„íŒ…ë°© ì…ì¥í•˜ë©´ í‘œì‹œë¨ -->
<div id="chat-area" style="display:none;">
    <h3 id="chat-room-title"></h3>
    <input type="text" id="sender" placeholder="ë‹‰ë„¤ì„" />
    <input type="text" id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
    <button onclick="sendMessage()">ì „ì†¡</button>

    <!-- ìˆ˜ì‹ ëœ ì±„íŒ… ë©”ì‹œì§€ ì¶œë ¥ ì˜ì—­ -->
    <ul id="chat-box"></ul>
</div>

<script>
    let stompClient = null; // STOMP í´ë¼ì´ì–¸íŠ¸ ê°ì²´
    let currentRoomId = null; // í˜„ì¬ ì…ì¥í•œ ë°©ì˜ ID

    // ë°© ìƒì„± ìš”ì²­
    function createRoom() {
        const roomName = document.getElementById("roomName").value;
        if (!roomName) return;

        fetch("/api/rooms?name=" + encodeURIComponent(roomName), {
            method: "POST"
        }).then(() => {
            document.getElementById("roomName").value = '';
            loadRoomList(); // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        });
    }

    // ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadRoomList() {
        fetch("/api/rooms")
            .then(res => res.json())
            .then(data => {
                const roomList = document.getElementById("room-list");
                roomList.innerHTML = '';
                data.forEach(room => {
                    const li = document.createElement("li");
                    li.innerHTML = `<button onclick="enterRoom('${room.roomId}', '${room.name}')">${room.name}</button>`;
                    roomList.appendChild(li);
                });
            });
    }

    // ë°© ì…ì¥
    function enterRoom(roomId, roomName) {
        currentRoomId = roomId;
        document.getElementById("chat-area").style.display = "block";
        document.getElementById("chat-room-title").innerText = "ì±„íŒ…ë°©: " + roomName;
        document.getElementById("chat-box").innerHTML = "";

        connectWebSocket(roomId); // WebSocket ì—°ê²°
    }

    // STOMP + WebSocket ì—°ê²° ë° êµ¬ë…
    function connectWebSocket(roomId) {
        const socket = new SockJS("/ws-chat"); // ë°±ì—”ë“œ WebSocket ì—”ë“œí¬ì¸íŠ¸
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            // íŠ¹ì • ì±„íŒ…ë°© topic êµ¬ë…
            stompClient.subscribe("/topic/room/" + roomId, function (msg) {
                const chat = JSON.parse(msg.body);
                const li = document.createElement("li");
                li.innerText = `${chat.sender}: ${chat.content}`;
                document.getElementById("chat-box").appendChild(li);
            });
        });
    }

    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
        const sender = document.getElementById("sender").value;
        const message = document.getElementById("message").value;

        if (!stompClient || !stompClient.connected || !currentRoomId) return;

        // ì„œë²„ì¸¡ /app/chat.sendë¡œ ë©”ì‹œì§€ ì „ì†¡ -> Kafka -> WebSocketìœ¼ë¡œ ë‹¤ì‹œ ìˆ˜ì‹ 
        stompClient.send("/app/chat.send", {}, JSON.stringify({
            sender: sender,
            content: message,
            roomId: currentRoomId
        }));

        document.getElementById("message").value = '';
    }

    // ì²˜ìŒ í˜ì´ì§€ ë¡œë“œ ì‹œ ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    loadRoomList();
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>실시간 채팅 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <h2>채팅 테스트</h2>
    <label>보내는 사람: <input type="text" id="sender" /></label><br/>
    <label>채팅방 ID: <input type="text" id="roomId" /></label><br/>
    <label>메시지: <input type="text" id="message" /></label>
    <button onclick="sendMessage()">전송</button>

    <hr/>
    <ul id="chat-box"></ul>

    <script>
        let stompClient = null;
        let roomId = null;

        function connectAndSubscribe(roomId) {
            const socket = new SockJS("http://localhost:8080/ws-chat");
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function () {
                stompClient.subscribe("/topic/room/" + roomId, function (msg) {
                    const chat = JSON.parse(msg.body);
                    const chatBox = document.getElementById("chat-box");
                    const li = document.createElement("li");
                    li.innerText = `${chat.sender}: ${chat.content}`;
                    chatBox.appendChild(li);
                });
            });
        }

        function sendMessage() {
            const sender = document.getElementById("sender").value;
            const message = document.getElementById("message").value;
            roomId = document.getElementById("roomId").value;

            if (!stompClient || !stompClient.connected) {
                connectAndSubscribe(roomId);
                // 연결이 완료되기 전에 전송 요청이 오면 300ms 뒤 재시도
                setTimeout(sendMessage, 300);
                return;
            }

            stompClient.send("/app/chat.send", {}, JSON.stringify({
                sender: sender,
                content: message,
                roomId: roomId
            }));

            document.getElementById("message").value = "";
        }
    </script>
</body>
</html>
